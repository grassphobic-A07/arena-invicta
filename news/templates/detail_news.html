{% extends 'base.html' %}

{% block title %}{{ news.title }}{% endblock %}

{% block content %}
<article>
    <!-- Header Berita dengan Gambar Latar Belakang -->
    {% if news.thumbnail %}
    <div class="relative aspect-video sm:aspect-[3/1] w-full overflow-hidden flex flex-col justify-end p-6 sm:p-8 text-white bg-cover bg-center mb-6" style="background-image: url('{{ news.thumbnail }}');">
    {% else %}
    <div class="relative aspect-video sm:aspect-[3/1] w-full overflow-hidden flex flex-col justify-end p-6 sm:p-8 text-white bg-gradient-to-r from-primary to-sea mb-6">
    {% endif %}
        <!-- Gradien untuk keterbacaan teks -->
        <div class="absolute inset-0 bg-gradient-to-t from-primary/80 via-primary/50 to-transparent"></div>
        <div class="relative z-10">
            <!-- Kategori dan Olahraga -->
            <div class="flex items-center gap-2 mb-2">
                <span class="inline-block bg-black/40 text-mist text-xs font-semibold capitalize px-2 py-1 rounded-md">{{ news.get_sports_display }}</span>
                <span class="inline-block bg-black/40 text-mist text-xs font-semibold capitalize px-2 py-1 rounded-md">{{ news.get_category_display }}</span>
            </div>
            <!-- Judul Berita -->
            <h1 class="text-3xl md:text-4xl font-bold leading-tight">{{ news.title }}</h1>
        </div>
    </div>

    <div class="mt-8 text-left">
        <a href="{% url 'news:show_news' %}" class="inline-flex items-center h-10 px-4 rounded-lg text-sm transition font-semibold text-primary bg-mist/70 border border-mist hover:text-sea">
            &larr; Back to News
        </a>
    </div>
    <!-- Konten Berita -->
    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mx-[15px]">
        <!-- Meta Info -->
        <div class="flex items-center justify-between text-sm text-surface/70 mb-10 pb-4 border-b border-mist">
            <span>Published on: {{ news.created_at|date:"F d, Y" }}</span>
            <span>Views: {{ news.news_views }}</span>
        </div>
        
        <!-- Isi Konten -->
        <div class="prose max-w-none text-surface/90">
            {{ news.content|linebreaks }}
        </div>
        <!-- Nama Author -->
        {% if news.author %}  <div class="mt-8 pt-4 border-t border-mist text-right text-sm text-surface/80">
            <span>Written by: </span>
            <strong class="font-semibold text-surface/90">
                {{ news.author.profile.display_name|default:news.author.username }}
            </strong>
        </div>
        {% endif %}
    </div>

    {% if request.user.is_authenticated and request.user == news.author %}
    <div class="mt-2 pt-1 mb-4 mr-3 border-t border-mist flex flex-wrap items-center justify-end gap-3">
        <!-- Tombol Edit -->
        <button type="button" 
                onclick="openEditNewsModal('{% url 'news:get_news_data_json' news.id %}', '{% url 'news:edit_news_ajax' news.id %}')" 
                class="inline-flex items-center h-10 px-4 rounded-lg text-sm font-semibold transition bg-sea/10 text-sea border border-sea/30 hover:bg-sea/20">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
            Edit News
        </button>
        <!-- Tombol Delete -->
        <button type="button" 
                onclick="confirmDeleteNewsAjax('{% url 'news:delete_news_ajax' news.id %}')"
                class="inline-flex items-center h-10 px-4 rounded-lg text-sm font-semibold transition bg-danger/10 text-danger border border-danger/30 hover:bg-danger/20">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            Delete News
        </button>
    </div>
    {% endif %}

</article>
{% include 'modal.html' %}
{% endblock %}

{% block scripts %}
<script>
    async function openEditNewsModal(dataUrl, submitUrl){
        // Ambil elemen modal dan form (asumsi ada di modal.html)
        const modal = document.getElementById('addNewsModal');
        const modalContent = document.getElementById('addNewsModalContent');
        const form = document.getElementById('addNewsForm');
        const titleElement = document.getElementById('addNewsModalTitle');
        const submitButtonText = modalContent.querySelector('.submit-button .submit-text');
        
        if(!modal || !form || !titleElement || !submitButtonText){
            console.error("Modal elements not found!");
            alert("Error: Could not prepare the edit form.");
            return;
        }

        // --- 1. Fetch Existing Data ---
        try{
            const response = await fetch(dataUrl); // Kirim GET request ke get_news_data_json
            if(!response.ok){
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const newsData = await response.json();
            console.log("Data diterima:", newsData);
            // --- 2. Populate Form ---
            form.querySelector('#modal_title').value = newsData.title || '';
            form.querySelector('#modal_content').value = newsData.content || '';
            form.querySelector('#modal_category').value = newsData.category || '';
            form.querySelector('#modal_sports').value = newsData.sports || '';
            form.querySelector('#modal_thumbnail').value = newsData.thumbnail || '';
            form.querySelector('#modal_is_featured').checked = newsData.is_featured || false;

            // --- 3. Update Modal Appearance ---
            titleElement.textContent = "Edit News";
            submitButtonText.textContent = "Update News";
            
            // --- 4. Set Form Action ---
            form.action = submitUrl;

            // --- 5. Show Modal ---
            showNewsModal();

        } 
        catch(error){
            console.error("Error fetching or populating edit data:", error);
             if(window.showToast){ 
                showToast('Could not load news data for editing.', 'error');
             } 
             else{
                alert('Could not load news data for editing.');
             }
        }
    }

    // Fungsi ini akan dipanggil saat tombol Delete diklik
    async function confirmDeleteNewsAjax(deleteUrl){
        const confirmed = await window.Confirm.open({
            titleText: 'Delete News Confirmation', // Judul modal
            messageText: 'Are you sure you want to permanently delete this news article? This action cannot be undone.', // Pesan konfirmasi
            confirmText: 'Yes, Delete', // Teks tombol konfirmasi
            tone: 'danger' // Warna merah untuk tombol konfirmasi
        });

        // Jika pengguna menekan tombol konfirmasi (misal "Yes, Delete")
        if(confirmed){
            try{
                // Kirim request POST ke URL delete AJAX
                const response = await fetch(deleteUrl, {
                    method: 'POST', // Gunakan POST untuk mengirim CSRF token
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest', // Tandai sebagai AJAX
                        'Content-Type': 'application/json' // Header standar
                    },
                });

                // Tunggu dan parse respons JSON dari server
                const data = await response.json();

                // Cek jika request berhasil (status OK 200-299) dan ada flag 'ok: true' dari view
                if(response.ok && data.ok){
                    // SUKSES
                    // Simpan pesan sukses ke localStorage agar bisa ditampilkan setelah redirect
                    localStorage.setItem("ai_toast", JSON.stringify({ text: data.message, level: "success" }));
                    // Redirect ke halaman daftar berita (URL didapat dari respons JSON)
                    window.location.href = data.redirect_url;
                }
                else{
                    // GAGAL (server mengembalikan error 4xx atau 5xx, atau data.ok false)
                    console.error("Delete failed:", data.error || `Server responded with status ${response.status}`);
                    // Tampilkan toast error dengan pesan dari server atau pesan default
                    // Pastikan showToast tersedia secara global (dari base.html)
                    if(window.showToast){
                       showToast(data.error || 'Could not delete the news article.', 'error');
                    } 
                    else{
                       alert(data.error || 'Could not delete the news article.'); // Fallback alert
                    }
                }

            } 
            catch(error){
                // Tangani error network atau error JavaScript lainnya
                console.error('Network or JS error during delete request:', error);
                 if(window.showToast){
                    showToast('A network or script error occurred. Please check console and try again.', 'error');
                 } 
                 else{
                    alert('A network or script error occurred. Please try again.'); // Fallback alert
                 }
            } 
        }
        // Jika pengguna menekan "Cancel" di modal, tidak terjadi apa-apa
    }
</script>
{% endblock scripts %}
