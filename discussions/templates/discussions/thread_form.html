{% extends 'base.html' %}

{% block title %}
{% if form.instance.pk %}Edit Diskusi Â· {{ form.instance.title }}{% else %}Buat Diskusi Baru{% endif %}
{% endblock %}
{% block content %}
<section class="mx-auto max-w-3xl px-4 py-8 space-y-6">
  <div class="flex items-center gap-2 text-sm text-surface/60">
    <a href="{% url 'discussions:thread-list' %}" class="inline-flex items-center gap-1 text-primary transition hover:text-primary/70">
      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m15 18-6-6 6-6"></path>
      </svg>
      Kembali ke daftar
    </a>
  </div>

  <div class="rounded-2xl border border-surface/15 bg-white/95 p-6 shadow-sm">
    <header class="mb-6 space-y-1">
      <h1 class="text-2xl font-semibold text-primary">
        {% if form.instance.pk %}Edit Diskusi{% else %}Diskusi Baru{% endif %}
      </h1>
      <p class="text-sm text-surface/60">
        {% if form.instance.pk %}
          Perbarui informasi diskusi untuk menjaga percakapan tetap relevan.
        {% else %}
          Mulai percakapan baru dan ajak komunitas untuk berdiskusi.
        {% endif %}
      </p>
    </header>

    <form method="post" class="space-y-4">
      {% csrf_token %}

      <div class="space-y-2">
        <label id="thread-edit-news-label"
               for="thread-edit-news-search"
               class="text-sm font-medium text-surface/80">Berita terkait</label>
        <div class="relative" data-thread-edit-combobox>
          <input type="hidden"
                 name="{{ form.news.html_name }}"
                 id="{{ form.news.id_for_label }}"
                 value="{{ form.news.value|default_if_none:'' }}"
                 data-thread-edit-hidden>
          <button type="button"
                  class="flex w-full items-center justify-between rounded-lg border bg-white px-3 py-2 text-left text-sm text-surface/60 transition hover:border-primary/40 focus:outline-none focus:ring-2 focus:ring-primary/20 {% if form.news.errors %}border-danger focus:border-danger focus:ring-danger/30 text-danger{% else %}border-surface/20{% endif %}"
                  data-thread-edit-toggle
                  role="combobox"
                  aria-haspopup="listbox"
                  aria-expanded="false"
                  aria-labelledby="thread-edit-news-label"
                  aria-controls="thread-edit-news-panel"
                  data-placeholder="Pilih berita...">
            <span class="line-clamp-1" data-thread-edit-toggle-label>Pilih berita...</span>
            <svg class="ml-2 h-4 w-4 text-surface/40 transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" data-thread-edit-toggle-icon>
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.11l3.71-3.88a.75.75 0 1 1 1.08 1.04l-4.25 4.44a.75.75 0 0 1-1.08 0L5.21 8.29a.75.75 0 0 1 .02-1.08Z" clip-rule="evenodd" />
            </svg>
          </button>
          <div id="thread-edit-news-panel"
               class="absolute left-0 right-0 z-20 mt-2 hidden overflow-hidden rounded-xl border border-surface/20 bg-white shadow-xl"
               data-thread-edit-panel>
            <div class="flex items-center gap-2 border-b border-surface/10 px-3 py-2">
              <svg class="h-4 w-4 text-surface/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input id="thread-edit-news-search"
                     type="text"
                     autocomplete="off"
                     placeholder="Cari berita..."
                     class="w-full border-none bg-transparent text-sm text-surface/80 focus:outline-none"
                     data-thread-edit-search>
            </div>
            <ul class="max-h-60 overflow-y-auto py-1"
                role="listbox"
                aria-labelledby="thread-edit-news-label"
                data-thread-edit-options>
              {% for news in form.news.field.queryset %}
                <li role="option"
                    tabindex="-1"
                    data-thread-edit-option
                    data-value="{{ news.pk }}"
                    class="cursor-pointer px-3 py-2 text-sm text-surface/70 transition hover:bg-mist">
                  {{ news.title }} ({{ news.pk }})
                </li>
              {% endfor %}
            </ul>
            <p class="hidden px-3 py-3 text-xs text-surface/50" data-thread-edit-empty>Tidak ada berita yang cocok.</p>
          </div>
        </div>
        {% if form.news.help_text %}
          <p class="text-xs text-surface/50">{{ form.news.help_text }}</p>
        {% endif %}
        {% if form.news.errors %}
          <p class="text-xs text-danger">{{ form.news.errors.0 }}</p>
        {% endif %}
      </div>

      <div class="space-y-2">
        <label for="{{ form.title.id_for_label }}" class="text-sm font-medium text-surface/80">Judul thread</label>
        {{ form.title }}
        {% if form.title.errors %}
          <p class="text-xs text-danger">{{ form.title.errors.0 }}</p>
        {% endif %}
      </div>

      <div class="space-y-2">
        <label for="{{ form.body.id_for_label }}" class="text-sm font-medium text-surface/80">Pembuka diskusi</label>
        {{ form.body }}
        {% if form.body.errors %}
          <p class="text-xs text-danger">{{ form.body.errors.0 }}</p>
        {% endif %}
      </div>

      <div class="flex flex-wrap items-center gap-3 pt-2">
        <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-medium text-white transition hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/30">
          Simpan Diskusi
        </button>
        <a href="{% if form.instance.pk %}{% url 'discussions:thread-detail' form.instance.pk %}{% else %}{% url 'discussions:thread-list' %}{% endif %}" class="inline-flex items-center gap-2 rounded-lg border border-surface/20 bg-white px-4 py-2 text-sm text-surface/70 transition hover:border-primary/40 hover:text-primary">
          Batal
        </a>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
    (function () {
      const combobox = document.querySelector("[data-thread-edit-combobox]");
      if (!combobox) return;

      const hiddenInput = combobox.querySelector("[data-thread-edit-hidden]");
      const toggle = combobox.querySelector("[data-thread-edit-toggle]");
      const toggleLabel = combobox.querySelector("[data-thread-edit-toggle-label]");
      const toggleIcon = combobox.querySelector("[data-thread-edit-toggle-icon]");
      const panel = combobox.querySelector("[data-thread-edit-panel]");
      const searchInput = combobox.querySelector("[data-thread-edit-search]");
      const emptyState = combobox.querySelector("[data-thread-edit-empty]");
      const options = Array.from(combobox.querySelectorAll("[data-thread-edit-option]"));
      const placeholder = (toggle?.dataset.placeholder || "Pilih berita...").trim();
      let isOpen = false;

      function updateLabel(text, isPlaceholder) {
        if (!toggleLabel || !toggle) return;
        toggleLabel.textContent = text;
        toggle.classList.toggle("text-surface/60", !!isPlaceholder);
        toggle.classList.toggle("text-surface/80", !isPlaceholder);
      }

      function getVisibleOptions() {
        return options.filter((option) => !option.classList.contains("hidden"));
      }

      function filterOptions(term) {
        const query = (term || "").trim().toLowerCase();
        let visibleCount = 0;
        options.forEach((option) => {
          const matches = option.textContent.toLowerCase().includes(query);
          option.classList.toggle("hidden", !matches);
          if (matches) {
            option.removeAttribute("aria-hidden");
            visibleCount += 1;
          } else {
            option.setAttribute("aria-hidden", "true");
          }
        });
        if (emptyState) {
          emptyState.classList.toggle("hidden", visibleCount !== 0);
        }
        return visibleCount;
      }

      function focusVisibleOption(position) {
        const visible = getVisibleOptions();
        if (!visible.length) return;
        const target = position === "last" ? visible[visible.length - 1] : visible[0];
        requestAnimationFrame(() => target.focus());
      }

      function focusRelativeOption(current, delta) {
        const visible = getVisibleOptions();
        if (!visible.length) return;
        const index = visible.indexOf(current);
        if (index === -1) {
          (delta > 0 ? visible[0] : visible[visible.length - 1])?.focus();
          return;
        }
        const nextIndex = (index + delta + visible.length) % visible.length;
        visible[nextIndex]?.focus();
      }

      function closePanel() {
        if (!isOpen) return;
        isOpen = false;
        panel?.classList.add("hidden");
        toggle?.setAttribute("aria-expanded", "false");
        toggleIcon?.classList.remove("rotate-180");
        document.removeEventListener("click", handleOutsideClick);
        document.removeEventListener("keydown", handleGlobalKeydown);
      }

      function openPanel(options = {}) {
        if (isOpen) return;
        const { focusSearch = true } = options;
        isOpen = true;
        panel?.classList.remove("hidden");
        toggle?.setAttribute("aria-expanded", "true");
        toggleIcon?.classList.add("rotate-180");
        if (searchInput) {
          searchInput.value = "";
        }
        filterOptions("");
        const selected = combobox.querySelector("[data-thread-edit-option][aria-selected='true']");
        if (selected) {
          requestAnimationFrame(() => selected.scrollIntoView({ block: "nearest" }));
        }
        if (focusSearch && searchInput) {
          requestAnimationFrame(() => searchInput.focus());
        }
        document.addEventListener("click", handleOutsideClick);
        document.addEventListener("keydown", handleGlobalKeydown);
      }

      function handleOutsideClick(event) {
        if (!isOpen) return;
        if (!combobox.contains(event.target)) {
          closePanel();
        }
      }

      function handleGlobalKeydown(event) {
        if (!isOpen) return;
        if (event.key === "Escape") {
          event.preventDefault();
          closePanel();
          toggle?.focus();
        } else if (event.key === "Tab") {
          closePanel();
        }
      }

      function selectOption(option, { silent = false } = {}) {
        if (!option) return;
        const value = option.dataset.value || "";
        if (hiddenInput) {
          hiddenInput.value = value;
        }
        options.forEach((item) => {
          item.classList.remove("bg-primary/5", "text-primary");
          item.removeAttribute("aria-selected");
        });
        option.classList.add("bg-primary/5", "text-primary");
        option.setAttribute("aria-selected", "true");
        updateLabel(option.textContent.trim() || placeholder, !value);
        if (toggle) {
          toggle.classList.remove("border-danger", "focus:border-danger", "focus:ring-danger/30", "text-danger");
          toggle.classList.add("border-surface/20");
        }
        if (!silent) {
          closePanel();
          toggle?.focus();
        }
      }

      if (toggle) {
        toggle.addEventListener("click", (event) => {
          event.preventDefault();
          if (isOpen) {
            closePanel();
          } else {
            openPanel();
          }
        });

        toggle.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            if (isOpen) {
              closePanel();
            } else {
              openPanel();
            }
          } else if (event.key === "ArrowDown") {
            event.preventDefault();
            if (!isOpen) {
              openPanel({ focusSearch: false });
            }
            focusVisibleOption("first");
          } else if (event.key === "ArrowUp") {
            event.preventDefault();
            if (!isOpen) {
              openPanel({ focusSearch: false });
            }
            focusVisibleOption("last");
          } else if (event.key === "Escape" && isOpen) {
            event.preventDefault();
            closePanel();
          }
        });
      }

      if (searchInput) {
        searchInput.addEventListener("input", (event) => {
          filterOptions(event.target.value);
        });

        searchInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            const [firstVisible] = getVisibleOptions();
            selectOption(firstVisible);
          } else if (event.key === "ArrowDown") {
            event.preventDefault();
            focusVisibleOption("first");
          } else if (event.key === "ArrowUp") {
            event.preventDefault();
            focusVisibleOption("last");
          } else if (event.key === "Escape") {
            event.preventDefault();
            closePanel();
            toggle?.focus();
          }
        });
      }

      options.forEach((option) => {
        option.addEventListener("click", () => selectOption(option));
        option.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            selectOption(option);
          } else if (event.key === "ArrowDown") {
            event.preventDefault();
            focusRelativeOption(option, 1);
          } else if (event.key === "ArrowUp") {
            event.preventDefault();
            focusRelativeOption(option, -1);
          } else if (event.key === "Escape") {
            event.preventDefault();
            closePanel();
            toggle?.focus();
          }
        });
      });

      updateLabel(placeholder, true);
      const initialValue = hiddenInput?.value?.trim();
      if (initialValue) {
        const initialOption = options.find((option) => option.dataset.value === initialValue);
        if (initialOption) {
          selectOption(initialOption, { silent: true });
        }
      }
    })();
  </script>
{% endblock %}
