{% extends 'base.html' %}

{% block title %}{{ thread.title }} 路 Diskusi{% endblock %}

{% block content %}
<section class="mx-auto max-w-5xl px-4 py-10 space-y-8">
  
  <div class="flex items-center gap-2 text-sm">
    <a href="{% url 'discussions:thread-list' %}" class="inline-flex items-center gap-2 text-gray-400 transition hover:text-white group">
      <div class="p-1 rounded-full bg-white/5 group-hover:bg-white/10 transition">
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg>
      </div>
      <span>Kembali ke daftar diskusi</span>
    </a>
  </div>

  <article class="relative rounded-3xl border border-white/10 bg-[#2A1B54]/80 backdrop-blur-xl p-6 md:p-8 shadow-2xl overflow-hidden">
    
    <div class="absolute top-0 right-0 w-64 h-64 bg-primary/20 rounded-full blur-[80px] -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

    <header class="flex flex-col gap-4 sm:flex-row sm:justify-between sm:items-start relative z-10">
      <div class="flex items-center gap-4">
        <div class="relative">
            {% if thread_author_profile and thread_author_profile.avatar_url %}
              <img src="{{ thread_author_profile.avatar_url }}" alt="{{ thread_author_display }}" class="h-14 w-14 rounded-full object-cover ring-2 ring-white/10 shadow-lg">
            {% else %}
              <div class="grid h-14 w-14 place-items-center rounded-full bg-primary/20 text-lg font-bold text-primary ring-2 ring-white/10 shadow-lg">
                {{ thread_author_display|slice:":2"|upper }}
              </div>
            {% endif %}
            <span class="absolute bottom-0 right-0 block h-3.5 w-3.5 rounded-full bg-green-500 ring-2 ring-[#2A1B54]"></span>
        </div>

        <div>
          <p class="text-base font-bold text-white">
            {{ thread_author_display }}
          </p>
          <p class="text-xs text-gray-400 mt-0.5">
            Published on {{ thread.created_at|date:"j F Y 路 H.i" }}
          </p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        {% if thread.is_pinned %}
          <span class="inline-flex items-center gap-1.5 rounded-full bg-yellow-500/20 px-3 py-1 text-[11px] font-bold uppercase tracking-wide text-yellow-400 border border-yellow-500/30 shadow-sm">
            <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17V3"></path><path d="m5 11 7 6 7-6"></path></svg>
            Pinned
          </span>
        {% endif %}
        {% if thread.is_locked %}
          <span class="inline-flex items-center gap-1.5 rounded-full bg-red-500/20 px-3 py-1 text-[11px] font-bold uppercase tracking-wide text-red-400 border border-red-500/30 shadow-sm">
            <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 10V8a6 6 0 1 1 12 0v2"></path><rect width="18" height="12" x="3" y="10" rx="2"></rect></svg>
            Locked
          </span>
        {% endif %}
      </div>
    </header>

    <div class="flex flex-wrap items-center gap-3 mt-6 pb-6 border-b border-white/5 relative z-10">
      {% if user.is_authenticated %}
        <button type="button"
                class="inline-flex items-center gap-2 rounded-xl border border-white/10 bg-black/20 px-4 py-2 text-sm font-medium text-gray-300 transition hover:bg-white/10 hover:text-white focus:outline-none focus:ring-2 focus:ring-primary/50"
                data-upvote-button
                data-upvote-url="{% url 'discussions:thread-upvote' thread.pk %}"
                data-upvoted="{{ user_has_upvoted|yesno:'true,false' }}"
                data-upvote-count="{{ upvote_count }}">
          <svg class="h-4 w-4 transition-transform group-active:-translate-y-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-upvote-icon>
            <path d="M5 15l7-12 7 12"></path><path d="M5 21h14"></path>
          </svg>
          <span data-upvote-label>{{ user_has_upvoted|yesno:"Upvoted,Upvote" }}</span>
          <span class="ml-1 rounded-md bg-white/10 px-1.5 py-0.5 text-xs font-bold text-white" data-upvote-count>{{ upvote_count }}</span>
        </button>
      {% else %}
        <a href="{% url 'accounts:login' %}?next={% url 'discussions:thread-detail' thread.pk %}"
           class="inline-flex items-center gap-2 rounded-xl border border-white/10 bg-black/20 px-4 py-2 text-sm font-medium text-gray-300 transition hover:bg-white/10 hover:text-white">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 15l7-12 7 12"></path><path d="M5 21h14"></path></svg>
          Upvote
          <span class="ml-1 rounded-md bg-white/10 px-1.5 py-0.5 text-xs font-bold text-white">{{ upvote_count }}</span>
        </a>
      {% endif %}
      
      <span class="inline-flex items-center gap-2 rounded-xl bg-white/5 border border-white/5 px-3 py-2 text-xs font-semibold text-gray-400">
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        <span data-thread-views>{{ thread.views_count }}</span> views
      </span>
      <span class="inline-flex items-center gap-2 rounded-xl bg-white/5 border border-white/5 px-3 py-2 text-xs font-semibold text-gray-400">
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        {{ comments|length }} comments
      </span>
    </div>

    <div class="mt-6 space-y-4 relative z-10">
      <h1 class="text-3xl font-extrabold text-white leading-tight">{{ thread.title }}</h1>
      <div class="prose prose-invert max-w-none text-gray-300 leading-relaxed text-sm md:text-base">
        <p class="whitespace-pre-wrap">{{ thread.body|default:"Belum ada deskripsi untuk diskusi ini." }}</p>
      </div>
    </div>

    <div class="mt-8 rounded-2xl border border-white/10 bg-black/30 p-5 relative z-10 hover:border-primary/30 transition group">
      <p class="text-[10px] font-bold uppercase tracking-widest text-gray-500 mb-3">Discussed News Topic</p>
      {% if thread.news and thread.news.uuid %}
        <a href="{% url 'news:detail_news' thread.news_id %}" class="flex flex-col gap-1 group-hover:opacity-100">
          <span class="text-lg font-bold text-primary group-hover:text-secondary transition">{{ thread.news.title }}</span>
          <span class="text-xs font-mono text-gray-600">ID: {{ thread.news_id }}</span>
          {% with snippet=thread.news.content %}
            {% if snippet %}
              <p class="mt-2 text-sm text-gray-400 line-clamp-2 border-l-2 border-white/10 pl-3 italic">{{ snippet|truncatewords:24 }}</p>
            {% endif %}
          {% endwith %}
        </a>
      {% else %}
        <div class="flex items-center gap-2 text-sm text-gray-500 italic">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            No specific news article linked to this discussion.
        </div>
      {% endif %}
    </div>

    {% if user.is_authenticated %}
      {% if user == thread.author or user.is_staff %}
        <div class="mt-8 flex flex-wrap gap-3 pt-6 border-t border-white/10">
          <a href="{% url 'discussions:thread-edit' thread.pk %}" class="inline-flex items-center gap-2 rounded-xl bg-white/5 border border-white/10 px-4 py-2 text-sm font-medium text-white transition hover:bg-white/10 hover:border-white/20">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"></path></svg>
            Edit Thread
          </a>
          <button type="button" id="thread-delete-trigger" class="inline-flex items-center gap-2 rounded-xl bg-red-500/10 border border-red-500/20 px-4 py-2 text-sm font-medium text-red-400 transition hover:bg-red-500/20 hover:text-red-300">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
            Delete Thread
          </button>
        </div>
      {% endif %}
      {% if user.is_authenticated %}
        {% if user == thread.author or user.is_staff %}
          <form id="thread-delete-form" method="post" action="{% url 'discussions:thread-delete' thread.pk %}" class="hidden">
            {% csrf_token %}
          </form>
        {% endif %}
      {% endif %}
    {% endif %}
  </article>

  <section class="space-y-6">
    <header class="flex items-center justify-between">
      <div>
          <h2 class="text-2xl font-bold text-white">Comments</h2>
          <p class="text-sm text-gray-400 mt-1">Join the conversation below.</p>
      </div>
      <div class="h-px flex-grow bg-white/10 ml-6"></div>
    </header>

    {% if user.is_authenticated and not thread.is_locked %}
      <form method="post" action="{% url 'discussions:comment-create' thread.pk %}" class="relative rounded-2xl border border-white/10 bg-[#2A1B54]/40 p-5 shadow-lg backdrop-blur-md">
        {% csrf_token %}
        <div class="space-y-3">
          <label for="id_content" class="text-xs font-bold text-secondary uppercase tracking-wider">Add a comment</label>
          <div class="relative">
              {{ comment_form.content }} </div>
        </div>
        <div class="mt-3 flex justify-end">
            <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-primary to-secondary px-6 py-2.5 text-sm font-bold text-white shadow-lg hover:shadow-primary/40 transition transform hover:-translate-y-0.5">
            Post Comment
            </button>
        </div>
      </form>
    {% elif thread.is_locked %}
      <div class="rounded-2xl border border-red-500/30 bg-red-500/10 px-6 py-4 text-center">
        <p class="text-sm font-bold text-red-400 uppercase tracking-wide">Thread Locked</p>
        <p class="text-xs text-red-300/70 mt-1">New comments are disabled for this discussion.</p>
      </div>
    {% else %}
      <div class="rounded-2xl border border-white/10 bg-white/5 px-6 py-8 text-center backdrop-blur-sm">
        <p class="text-gray-400 mb-3">Login to join the discussion.</p>
        <a href="{% url 'accounts:login' %}" class="inline-block rounded-xl bg-white/10 px-6 py-2 text-sm font-bold text-white hover:bg-white/20 transition">Login Now</a>
      </div>
    {% endif %}

    <div class="space-y-4">
        {% for comment in comments %}
        <article class="group rounded-2xl border border-white/5 bg-[#1A103C]/60 p-5 shadow-md transition hover:border-white/10 hover:bg-[#1A103C]/80">
          <div class="flex items-start gap-4">
            
            <div class="flex-shrink-0">
                {% with c_profile=comment.author_profile %}
                  {% if c_profile and c_profile.avatar_url %}
                    <img src="{{ c_profile.avatar_url }}" alt="{{ comment.author_display }}" class="h-10 w-10 rounded-full object-cover ring-2 ring-white/5">
                  {% else %}
                    <div class="grid h-10 w-10 place-items-center rounded-full bg-secondary/20 text-xs font-bold text-secondary ring-2 ring-white/5">
                      {{ comment.author_display|slice:":2"|upper }}
                    </div>
                  {% endif %}
                {% endwith %}
            </div>

            <div class="flex-1 min-w-0">
              <div class="flex flex-wrap items-center gap-2 mb-1">
                <span class="text-sm font-bold text-white">{{ comment.author_display }}</span>
                {% if comment.author == thread.author %}
                    <span class="rounded bg-primary/20 px-1.5 py-0.5 text-[10px] font-bold text-primary">OP</span>
                {% endif %}
                <span class="text-xs text-gray-500">路</span>
                <time datetime="{{ comment.created_at|date:'c' }}" class="text-xs text-gray-500">{{ comment.created_at|date:"j M Y 路 H.i" }}</time>
              </div>
              
              <div class="text-sm text-gray-300 leading-relaxed break-words" data-comment-content="{{ comment.pk }}">
                  {{ comment.content }}
              </div>

              {% if user.is_authenticated %}
                {% if comment.author == user or user.is_staff %}
                  <div class="mt-3 flex gap-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                    <button type="button"
                            class="inline-flex items-center gap-1.5 text-xs font-medium text-gray-400 hover:text-primary transition"
                            data-comment-edit-trigger
                            data-comment-id="{{ comment.pk }}"
                            data-comment-edit-url="{% url 'discussions:comment-edit' comment.pk %}"
                            data-comment-body="{{ comment.content|escapejs }}">
                      <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"></path></svg>
                      Edit
                    </button>
                    <button type="button"
                            class="inline-flex items-center gap-1.5 text-xs font-medium text-gray-400 hover:text-danger transition"
                            data-comment-delete-trigger
                            data-comment-id="{{ comment.pk }}"
                            data-comment-snippet="{{ comment.content|truncatechars:80|default_if_none:''|escape }}">
                      <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
                      Delete
                    </button>
                    <form id="comment-delete-form-{{ comment.pk }}"
                          method="post"
                          action="{% url 'discussions:comment-delete' comment.pk %}"
                          class="hidden"
                          data-comment-delete-form="{{ comment.pk }}">
                      {% csrf_token %}
                    </form>
                  </div>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </article>
      {% empty %}
        <div class="py-12 flex flex-col items-center justify-center text-center">
            <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mb-3 text-gray-600">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
            </div>
            <p class="text-gray-500">No comments yet. Be the first to start the conversation!</p>
        </div>
      {% endfor %}
    </div>
  </section>
</section>
{% endblock %}

{% block scripts %}
<div id="comment-edit-modal"
     class="fixed inset-0 z-[1250] hidden items-center justify-center p-4"
     role="dialog"
     aria-modal="true"
     aria-labelledby="comment-edit-modal-title">
  
  <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" data-comment-edit-close></div>
  
  <div id="comment-edit-modal-content"
       class="relative w-full max-w-lg transform rounded-2xl bg-[#2A1B54] border border-white/10 shadow-2xl transition-all duration-200 opacity-0 scale-95">
    
    <form id="comment-edit-form" class="flex flex-col gap-5 p-6">
      {% csrf_token %}
      <header class="flex items-start justify-between border-b border-white/10 pb-4">
        <div>
          <h3 id="comment-edit-modal-title" class="text-xl font-bold text-white">Edit Comment</h3>
          <p class="text-xs text-gray-400 mt-1">Update your thoughts.</p>
        </div>
        <button type="button"
                class="rounded-full p-2 text-gray-400 transition hover:bg-white/10 hover:text-white"
                data-comment-edit-close>
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 6 6 18M6 6l12 12"></path></svg>
        </button>
      </header>

      <div class="space-y-2">
        <label for="comment-edit-body" class="text-xs font-bold text-secondary uppercase tracking-wider">Comment Content</label>
        <textarea id="comment-edit-body"
                  name="content"
                  rows="4"
                  required
                  class="w-full rounded-xl border border-white/10 bg-black/30 px-4 py-3 text-sm text-white placeholder-gray-500 transition focus:border-secondary focus:outline-none focus:ring-1 focus:ring-secondary resize-none"></textarea>
        <p class="text-xs text-danger min-h-[1.1rem]" data-comment-edit-error></p>
      </div>

      <footer class="flex items-center justify-end gap-3 pt-2">
        <button type="button"
                class="rounded-xl border border-white/10 px-5 py-2.5 text-sm font-medium text-gray-400 transition hover:bg-white/10 hover:text-white"
                data-comment-edit-close>
          Cancel
        </button>
        <button type="submit"
                class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-primary to-secondary px-6 py-2.5 text-sm font-bold text-white shadow-lg hover:shadow-primary/30 transition transform hover:-translate-y-0.5">
          Save Changes
        </button>
      </footer>
    </form>
  </div>
</div>

<style type="text/tailwindcss">
  @layer utilities {
    textarea[name="content"] {
      @apply w-full rounded-xl border border-white/10 bg-black/30 px-4 py-3 text-sm text-white placeholder-white/30 outline-none focus:border-secondary focus:ring-1 focus:ring-secondary transition min-h-[100px];
    }
  }
</style>

{{ block.super }}
<script>
  (function () {
    // --- Helper: Get CSRF Cookie ---
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
      return "";
    }

    // --- Upvote Logic (UPDATED STYLE CLASSES FOR DARK MODE) ---
    function syncUpvoteState(button, count, isActive) {
      const label = button.querySelector("[data-upvote-label]");
      const countNode = button.querySelector("[data-upvote-count]");
      const icon = button.querySelector("[data-upvote-icon]");
      
      button.dataset.upvoted = isActive ? "true" : "false";
      
      // Active State (Dark Mode)
      if (isActive) {
          button.classList.add("border-primary", "bg-primary/20", "text-primary");
          button.classList.remove("border-white/10", "bg-black/20", "text-gray-300");
      } else {
          button.classList.remove("border-primary", "bg-primary/20", "text-primary");
          button.classList.add("border-white/10", "bg-black/20", "text-gray-300");
      }

      if (icon) icon.setAttribute("fill", isActive ? "currentColor" : "none");
      if (label) label.textContent = isActive ? "Upvoted" : "Upvote";
      if (countNode) countNode.textContent = count;
    }

    const upvoteButton = document.querySelector("[data-upvote-button]");
    if (upvoteButton) {
      const initialCount = parseInt(upvoteButton.dataset.upvoteCount || "0", 10);
      const isActive = upvoteButton.dataset.upvoted === "true";
      syncUpvoteState(upvoteButton, initialCount, isActive);

      upvoteButton.addEventListener("click", async (event) => {
        event.preventDefault();
        const url = upvoteButton.dataset.upvoteUrl;
        if (!url) return;
        const formInput = document.querySelector("input[name='csrfmiddlewaretoken']");
        const token = formInput ? formInput.value : getCookie("csrftoken");
        
        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "X-CSRFToken": token, "X-Requested-With": "XMLHttpRequest" },
          });
          if (!response.ok) throw new Error("Gagal update upvote.");
          const data = await response.json();
          if (!data.ok) throw new Error(data.error || "Gagal update upvote.");
          
          syncUpvoteState(upvoteButton, data.upvote_count ?? 0, data.state === "added");
        } catch (error) {
          console.error(error);
          window.showToast?.("Gagal update upvote.", "error");
        }
      });
    }

    // --- Delete Thread ---
    const threadDeleteTrigger = document.getElementById("thread-delete-trigger");
    const threadDeleteForm = document.getElementById("thread-delete-form");
    if (threadDeleteTrigger && threadDeleteForm) {
      threadDeleteTrigger.addEventListener("click", async () => {
        if (window.Confirm) {
            const ok = await window.Confirm.open({
              titleText: "Delete Thread?",
              messageText: "This action will permanently remove the discussion and all associated comments.",
              confirmText: "Delete Forever",
              tone: "danger",
            });
            if (ok) threadDeleteForm.submit();
        } else if (confirm("Delete this thread permanently?")) {
            threadDeleteForm.submit();
        }
      });
    }

    // --- Delete Comment ---
    document.querySelectorAll("[data-comment-delete-trigger]").forEach((button) => {
      button.addEventListener("click", async () => {
        const commentId = button.dataset.commentId;
        const form = document.querySelector(`[data-comment-delete-form="${commentId}"]`);
        if (!commentId || !form) return;

        if (window.Confirm) {
            const ok = await window.Confirm.open({
              titleText: "Delete Comment?",
              messageText: "Are you sure you want to remove this comment?",
              confirmText: "Yes, Delete",
              tone: "danger",
            });
            if (ok) form.submit();
        } else if (confirm("Delete this comment?")) {
            form.submit();
        }
      });
    });

    // --- Edit Comment Modal Logic ---
    const commentEditModal = document.getElementById("comment-edit-modal");
    const commentEditModalContent = document.getElementById("comment-edit-modal-content");
    const commentEditForm = document.getElementById("comment-edit-form");
    const commentEditTextarea = document.getElementById("comment-edit-body");
    const commentEditError = commentEditForm ? commentEditForm.querySelector("[data-comment-edit-error]") : null;
    let activeCommentEdit = null;

    function setCommentEditError(message = "") {
      if (commentEditError) commentEditError.textContent = message;
    }

    function openCommentEditModal(config) {
      if (!commentEditModal) return;
      activeCommentEdit = config;
      commentEditTextarea.value = config.body || "";
      setCommentEditError("");
      commentEditModal.classList.remove("hidden");
      commentEditModal.classList.add("flex");
      requestAnimationFrame(() => {
        commentEditModalContent.classList.remove("opacity-0", "scale-95");
        commentEditModalContent.classList.add("opacity-100", "scale-100");
      });
    }

    function closeCommentEditModal() {
      if (!commentEditModal) return;
      commentEditModalContent.classList.add("opacity-0", "scale-95");
      commentEditModalContent.classList.remove("opacity-100", "scale-100");
      setTimeout(() => {
        commentEditModal.classList.add("hidden");
        commentEditModal.classList.remove("flex");
        activeCommentEdit = null;
      }, 160);
    }

    document.querySelectorAll("[data-comment-edit-close]").forEach((btn) => 
      btn.addEventListener("click", closeCommentEditModal)
    );

    document.querySelectorAll("[data-comment-edit-trigger]").forEach((button) => {
      button.addEventListener("click", () => {
        const id = button.dataset.commentId;
        const url = button.dataset.commentEditUrl;
        const body = button.dataset.commentBody || "";
        const contentNode = document.querySelector(`[data-comment-content="${id}"]`);
        if (!id || !url) return;
        openCommentEditModal({ id, url, body, button, contentNode });
      });
    });

    commentEditForm?.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!activeCommentEdit) return;
      
      const rawValue = commentEditTextarea.value;
      const formInput = commentEditForm.querySelector("input[name='csrfmiddlewaretoken']");
      const token = formInput ? formInput.value : getCookie("csrftoken");
      
      try {
        const response = await fetch(activeCommentEdit.url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": token, "X-Requested-With": "XMLHttpRequest" },
          body: new URLSearchParams({ content: rawValue }),
        });
        
        const data = await response.json();
        if (!response.ok || !data.ok) throw new Error(data.error || "Update failed.");

        const updatedContent = data.content || rawValue;
        if (activeCommentEdit.contentNode) activeCommentEdit.contentNode.textContent = updatedContent;
        if (activeCommentEdit.button) activeCommentEdit.button.dataset.commentBody = updatedContent;
        
        window.showToast?.("Comment updated!", "success");
        closeCommentEditModal();
        
      } catch (error) {
        setCommentEditError(error.message);
      }
    });

  })();
</script>
{% endblock %}