{% extends 'base.html' %}
{% block title %}Daftar Tim • Premier League{% endblock %}

{% block content %}
<section class="mx-auto max-w-7xl px-4 py-8 space-y-8">

  <div>
    <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-white via-primary to-secondary drop-shadow-[0_0_15px_rgba(147,51,234,0.5)] mb-4">
      Premier League — Teams
    </h1>
    {% include 'leagues/_league_nav.html' with league=league current_nav='teams' %}
  </div>

  <form id="teamSearchForm" class="bg-[#2A1B54]/40 backdrop-blur-md border border-white/10 rounded-2xl p-4 flex items-center gap-4 shadow-lg max-w-xl" method="get" action="{% url 'leagues:team_list' league.pk %}"> 
    <div class="relative flex-grow">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        </div>
        <input type="text" name="q" value="{{ q }}" placeholder="Search team (e.g. Arsenal)"
               class="w-full h-11 rounded-xl bg-black/30 border border-white/10 pl-10 pr-4 text-white focus:border-secondary focus:ring-1 focus:ring-secondary outline-none transition placeholder-gray-500">
    </div>
    <button type="submit"
            class="h-11 px-6 rounded-xl bg-gradient-to-r from-primary to-secondary text-white font-bold shadow-lg hover:shadow-primary/30 transition transform hover:-translate-y-0.5">
      Search
    </button>
    <a href="{% url 'leagues:team_list' league.pk %}" class="h-11 px-4 inline-flex items-center rounded-xl border border-white/10 text-gray-400 hover:bg-white/10 hover:text-white transition font-medium">Reset</a>
  </form>

  <div id="teamListContainer" class="bg-[#2A1B54]/60 backdrop-blur-xl border border-white/10 rounded-2xl overflow-hidden shadow-2xl min-h-[300px]">
    {% include 'leagues/_team_list_partial.html' with teams=teams %} 
  </div>

  {% if page_obj.has_previous or page_obj.has_next %}
    <div class="flex items-center justify-between pt-4 border-t border-white/10">
      <div class="text-sm text-gray-400">
        Page <span class="font-bold text-white">{{ page_obj.number }}</span> of <span class="font-bold text-white">{{ page_obj.paginator.num_pages }}</span>
      </div>
      <div class="flex items-center gap-2">
        {% if page_obj.has_previous %}
          <a href="?q={{ q }}&page={{ page_obj.previous_page_number }}"
             class="h-9 px-4 rounded-lg border border-white/10 bg-white/5 text-gray-300 hover:bg-white/10 hover:text-white transition text-sm font-medium flex items-center">
            ← Prev
          </a>
        {% endif %}
        {% if page_obj.has_next %}
          <a href="?q={{ q }}&page={{ page_obj.next_page_number }}"
             class="h-9 px-4 rounded-lg border border-white/10 bg-white/5 text-gray-300 hover:bg-white/10 hover:text-white transition text-sm font-medium flex items-center">
            Next →
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}

  {# --- SCRIPT AJAX UNTUK SEARCH (Tetap sama) --- #}
  <script>
  (function () {
    const form = document.getElementById('teamSearchForm');
    const input = form.querySelector('input[name="q"]');
    const container = document.getElementById('teamListContainer');
    let searchTimer;

    const performSearch = async () => {
      const query = input.value;
      const url = new URL(form.action);
      url.searchParams.set('q', query);
      
      // Loading State (Dark Mode Style)
      container.innerHTML = `
        <div class="px-5 py-12 text-center text-gray-400 flex flex-col items-center justify-center">
            <svg class="animate-spin h-8 w-8 text-primary mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Searching teams...</span>
        </div>`;

      try {
        const resp = await fetch(url.href, { 
          method: "GET",
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });

        if (resp.ok) {
          const htmlResult = await resp.text(); 
          container.innerHTML = htmlResult; 
        } else {
          container.innerHTML = '<div class="px-5 py-12 text-center text-red-400 italic">Failed to load teams. Please try again.</div>';
          console.error("AJAX Error:", resp.status, resp.statusText);
        }
      } catch (err) {
        container.innerHTML = '<div class="px-5 py-12 text-center text-red-400 italic">Network error. Check your connection.</div>';
        console.error("Network Error:", err);
      }
      
      history.pushState({ q: query }, '', url.href); 
    };

    form.addEventListener('submit', (e) => {
      e.preventDefault(); 
      clearTimeout(searchTimer); 
      performSearch(); 
    });

    input.addEventListener('input', (e) => { 
      clearTimeout(searchTimer); 
      searchTimer = setTimeout(performSearch, 300); 
    });

    window.addEventListener('popstate', (event) => {
      const params = new URLSearchParams(window.location.search);
      const queryFromUrl = params.get('q') || '';
      input.value = queryFromUrl; 
      performSearch(); 
    });

  })();
  </script>
  
</section>
{% endblock %}