<header class="px-4 py-3 border-b border-surface/20 bg-white/80 backdrop-blur">
  <div class="mx-auto max-w-3xl">
    <div class="relative flex items-center justify-between gap-3">
      {% url 'accounts:home' as home_url %}
      <a href="{{ home_url }}" class="font-semibold text-primary">Arena Invicta</a>

      {% url 'accounts:login' as login_url %}
      {% url 'accounts:register' as register_url %}
      {% url 'accounts:profile_detail' as profile_url %}
      {% url 'accounts:logout' as logout_url %}

      {# ============== DESKTOP NAV (â‰¥ md) ============== #}
      <nav class="hidden md:flex items-center gap-2">
        <a href="{{ home_url }}"
           class="inline-flex items-center h-9 px-3 rounded-lg text-sm transition focus:outline-none focus:ring-2 focus:ring-sea/30
                  {% if request.path == home_url %}font-semibold text-primary bg-mist/70 border border-mist{% else %}text-surface/80 hover:text-sea{% endif %}"
           {% if request.path == home_url %}aria-current="page"{% endif %}>
          <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M3 12l9-9 9 9M4 10v10h16V10"/></svg>
          Home
        </a>

        {% if request.user.is_authenticated %}
          {# ---- Avatar trigger (gabungan Profil + Logout) ---- #}
          <div class="relative">
            <button id="user-menu-button"
                    class="relative h-9 w-9 rounded-full border border-surface/20 bg-mist/50
                          flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-sea/30"
                    aria-haspopup="menu" aria-expanded="false" aria-controls="user-menu" aria-label="Open user menu">
              <!-- masker avatar: overflow di sini, BUKAN di tombol -->
              <span class="absolute inset-0 rounded-full overflow-hidden">
                {% if request.user.profile.avatar_url %}
                  <img src="{{ request.user.profile.avatar_url }}" alt=""
                      class="h-full w-full object-cover"
                      referrerpolicy="no-referrer"
                      onerror="this.classList.add('hidden'); this.nextElementSibling.classList.remove('hidden');">
                {% endif %}
                <svg class="absolute inset-0 m-auto w-5 h-5 text-surface/70 {% if request.user.profile.avatar_url %}hidden{% endif %}"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <circle cx="12" cy="8" r="4" stroke-width="2"/><path stroke-width="2" d="M6 20a6 6 0 0112 0"/>
                </svg>
              </span>

              <!-- badge chevron: tidak ikut ter-clip -->
              <span class="pointer-events-none absolute bottom-0 right-0 translate-x-1/6 translate-y-1/6
                          rounded-full bg-white ring-1 ring-surface/20 shadow flex items-center justify-center"
                    style="width:14px;height:14px">
                <svg id="user-chevron" class="w-3 h-3 text-surface/70 transition-transform duration-150"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-width="2" d="M6 9l6 6 6-6"/>
                </svg>
              </span>
            </button>

            <!-- dropdown -->
            <div id="user-menu"
                class="hidden absolute right-0 top-full mt-2 w-48 z-[60]
                        rounded-xl border border-mist bg-white shadow-2xl overflow-hidden"
                role="menu" aria-labelledby="user-menu-button">
              <a href="{{ profile_url }}"
                class="flex items-center gap-3 px-4 py-3 text-sm text-surface/90 hover:bg-mist/60"
                role="menuitem" {% if request.path == profile_url %}aria-current="page"{% endif %}>
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <circle cx="12" cy="8" r="4" stroke-width="2"/><path stroke-width="2" d="M6 20a6 6 0 0112 0"/>
                </svg>
                <span>My Profile</span>
              </a>
              <a href="{{ logout_url }}"
                class="flex items-center gap-3 px-4 py-3 text-sm text-danger/90 hover:bg-mist/60"
                role="menuitem">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-width="2" d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                  <path stroke-width="2" d="M14 7l5 5-5 5"/>
                  <path stroke-width="2" d="M19 12H9"/>
                </svg>
                <span>Logout</span>
              </a>
            </div>
          </div>
        {% else %}
          <a href="{{ login_url }}"
             class="inline-flex items-center h-9 px-3 rounded-lg text-sm transition focus:outline-none focus:ring-2 focus:ring-sea/30
                    {% if request.path == login_url %}font-semibold text-primary bg-mist/70 border border-mist{% else %}text-surface/80 hover:text-sea{% endif %}">
            <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/><path stroke-width="2" d="M10 17l5-5-5-5"/><path stroke-width="2" d="M15 12H3"/></svg>
            Login
          </a>
          <a href="{{ register_url }}"
             class="inline-flex items-center h-9 px-3 rounded-lg text-sm transition focus:outline-none focus:ring-2 focus:ring-sea/30
                    {% if request.path == register_url %}font-semibold text-primary bg-mist/70 border border-mist{% else %}text-surface/80 hover:text-sea{% endif %}">
            <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="8" r="4" stroke-width="2"/><path stroke-width="2" d="M6 20a6 6 0 0112 0"/><path stroke-width="2" d="M19 8h4M21 6v4"/></svg>
            Sign up
          </a>
        {% endif %}
      </nav>

      {# ============== HAMBURGER (mobile) ============== #}
      <button id="nav-toggle"
              class="md:hidden inline-flex items-center h-9 px-3 rounded-lg text-sm border border-surface/20 text-surface/80 hover:text-sea"
              aria-controls="mobile-sheet" aria-expanded="false" aria-label="Open navigation">
        <svg class="w-5 h-5 icon-open" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        <svg class="w-5 h-5 icon-close hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M6 6l12 12M6 18L18 6"/></svg>
      </button>
    </div>
  </div>
</header>

{# --------- Mobile floating sheet (header menampilkan avatar) --------- #}
<div id="mobile-backdrop" class="fixed inset-0 z-40 bg-black/30 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity md:hidden"></div>

<div id="mobile-sheet"
     class="fixed left-3 right-3 top-3 z-50 md:hidden
            translate-y-4 opacity-0 scale-95 pointer-events-none
            transition-all duration-200">
  <div class="rounded-2xl border border-mist bg-white/90 backdrop-blur-xl shadow-2xl overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 border-b border-mist/60 bg-gradient-to-r from-mist/60 to-white/40">
      <div class="flex items-center gap-3">
        {% if request.user.is_authenticated and request.user.profile.avatar_url %}
          <img src="{{ request.user.profile.avatar_url }}" alt="" class="h-8 w-8 rounded-full object-cover"
               referrerpolicy="no-referrer"
               onerror="this.classList.add('hidden'); this.nextElementSibling.classList.remove('hidden');">
          <svg class="hidden w-8 h-8 text-surface/70" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="8" r="4" stroke-width="2"/><path stroke-width="2" d="M6 20a6 6 0 0112 0"/></svg>
        {% else %}
          <svg class="w-8 h-8 text-surface/70" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="8" r="4" stroke-width="2"/><path stroke-width="2" d="M6 20a6 6 0 0112 0"/></svg>
        {% endif %}
        <span class="font-semibold text-primary">
          {% if request.user.is_authenticated %}{{ request.user.get_username }}{% else %}Menu{% endif %}
        </span>
      </div>
      <button id="nav-close" class="inline-flex h-9 w-9 items-center justify-center rounded-lg border border-surface/20 text-surface/80 hover:text-sea" aria-label="Close menu">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M6 6l12 12M6 18L18 6"/></svg>
      </button>
    </div>

    {% url 'accounts:home' as home_url %}
    {% url 'accounts:login' as login_url %}
    {% url 'accounts:register' as register_url %}
    {% url 'accounts:profile_detail' as profile_url %}
    {% url 'accounts:logout' as logout_url %}

    <nav class="p-3">
      <ul class="space-y-2">
        <li>
          <a href="{{ home_url }}" class="flex items-center gap-3 rounded-xl px-4 py-3 text-[15px] border {% if request.path == home_url %}border-mist bg-mist/70 font-semibold text-primary{% else %}border-surface/20 text-surface/90 hover:bg-mist/50{% endif %}">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M3 12l9-9 9 9M4 10v10h16V10"/></svg>
            <span>Home</span>
          </a>
        </li>

        {% if request.user.is_authenticated %}
          <li>
            <div class="rounded-xl border border-surface/20">
              <div class="px-4 pt-3 pb-1 text-xs tracking-wide text-surface/60">AKUN</div>
              <a href="{{ profile_url }}" class="flex items-center gap-3 px-4 py-3 text-[15px] hover:bg-mist/50 border-t border-surface/10">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="8" r="4" stroke-width="2"/><path stroke-width="2" d="M6 20a6 6 0 0112 0"/></svg>
                <span>My Profile</span>
              </a>
              <a href="{{ logout_url }}" class="flex items-center gap-3 px-4 py-3 text-danger hover:bg-mist/50 border-t border-surface/10">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><path stroke-width="2" d="M14 7l5 5-5 5"/><path stroke-width="2" d="M19 12H9"/></svg>
                <span>Logout</span>
              </a>
            </div>
          </li>
        {% else %}
          <li>
            <a href="{{ login_url }}" class="flex items-center gap-3 rounded-xl px-4 py-3 text-[15px] border {% if request.path == login_url %}border-mist bg-mist/70 font-semibold text-primary{% else %}border-surface/20 text-surface/90 hover:bg-mist/50{% endif %}">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/><path stroke-width="2" d="M10 17l5-5-5-5"/><path stroke-width="2" d="M15 12H3"/></svg>
              <span>Login</span>
            </a>
          </li>
          <li>
            <a href="{{ register_url }}" class="flex items-center gap-3 rounded-xl px-4 py-3 text-[15px] border {% if request.path == register_url %}border-mist bg-mist/70 font-semibold text-primary{% else %}border-surface/20 text-surface/90 hover:bg-mist/50{% endif %}">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="8" r="4" stroke-width="2"/><path stroke-width="2" d="M6 20a6 6 0 0112 0"/><path stroke-width="2" d="M19 8h4M21 6v4"/></svg>
              <span>Sign up</span>
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>

{# JS (toggle + dropdown) #}
<script>
  (function () {
    const navBtn   = document.getElementById('nav-toggle');
    const sheet    = document.getElementById('mobile-sheet');
    const backdrop = document.getElementById('mobile-backdrop');
    const closeBtn = document.getElementById('nav-close');

    function openSheet(){
      sheet.classList.remove('pointer-events-none','opacity-0','translate-y-4','scale-95');
      backdrop.classList.remove('pointer-events-none','opacity-0');
      sheet.classList.add('opacity-100','translate-y-0','scale-100','pointer-events-auto');
      backdrop.classList.add('opacity-100','pointer-events-auto');
      navBtn?.setAttribute('aria-expanded','true');
      navBtn?.querySelector('.icon-open')?.classList.add('hidden');
      navBtn?.querySelector('.icon-close')?.classList.remove('hidden');
    }
    function closeSheet(){
      sheet.classList.add('pointer-events-none','opacity-0','translate-y-4','scale-95');
      backdrop.classList.add('pointer-events-none','opacity-0');
      sheet.classList.remove('opacity-100','translate-y-0','scale-100','pointer-events-auto');
      backdrop.classList.remove('opacity-100','pointer-events-auto');
      navBtn?.setAttribute('aria-expanded','false');
      navBtn?.querySelector('.icon-open')?.classList.remove('hidden');
      navBtn?.querySelector('.icon-close')?.classList.add('hidden');
    }
    navBtn?.addEventListener('click', () => (sheet.classList.contains('opacity-100') ? closeSheet() : openSheet()));
    backdrop?.addEventListener('click', closeSheet);
    closeBtn?.addEventListener('click', closeSheet);
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeSheet(); });
    sheet?.addEventListener('click', e => { if (e.target.closest('a')) closeSheet(); });

    // Desktop user dropdown + chevron rotate
    const userBtn     = document.getElementById('user-menu-button');
    const userMenu    = document.getElementById('user-menu');
    const userChevron = document.getElementById('user-chevron');

    function closeUser(){
      userMenu?.classList.add('hidden');
      userBtn?.setAttribute('aria-expanded','false');
      userChevron?.classList.remove('rotate-180');
    }
    function openUser(){
      userMenu?.classList.remove('hidden');
      userBtn?.setAttribute('aria-expanded','true');
      userChevron?.classList.add('rotate-180');
    }
    userBtn?.addEventListener('click', () => (userMenu.classList.contains('hidden') ? openUser() : closeUser()));
    document.addEventListener('click', (e)=>{ if(!userMenu||!userBtn) return; if(userMenu.contains(e.target) || userBtn.contains(e.target)) return; closeUser(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeUser(); });
  })();
</script>
